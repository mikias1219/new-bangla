<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BanglaChatPro - AI Customer Care</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Bengali:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans Bengali', sans-serif; }
        .chat-container { height: calc(100vh - 200px); }
        .message-bubble { max-width: 80%; }
        .typing-indicator { animation: pulse 1.5s ease-in-out infinite; }
        .voice-wave { animation: wave 1s ease-in-out infinite; }
        @keyframes wave {
            0%, 100% { transform: scaleY(1); }
            50% { transform: scaleY(1.5); }
        }
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
    </style>
</head>
<body class="bg-gray-100" x-data="chatApp()">
    <!-- Header -->
    <header class="gradient-bg text-white shadow-lg">
        <div class="container mx-auto px-4 py-6">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <div class="w-12 h-12 bg-white bg-opacity-20 rounded-full flex items-center justify-center">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                        </svg>
                    </div>
                    <div>
                        <h1 class="text-2xl font-bold">BanglaChatPro</h1>
                        <p class="text-sm opacity-90">AI সহায়ক সেবা</p>
                    </div>
                </div>
                
                <div class="flex items-center space-x-4">
                    <!-- Language Toggle -->
                    <div class="flex items-center space-x-2">
                        <span class="text-sm">EN</span>
                        <button @click="toggleLanguage()" class="relative inline-flex h-6 w-11 items-center rounded-full transition-colors" :class="language === 'bn' ? 'bg-blue-600' : 'bg-gray-200'">
                            <span class="inline-block h-4 w-4 transform rounded-full bg-white transition-transform" :class="language === 'bn' ? 'translate-x-6' : 'translate-x-1'"></span>
                        </button>
                        <span class="text-sm">বাংলা</span>
                    </div>
                    
                    <!-- Voice Mode Toggle -->
                    <button @click="toggleVoiceMode()" class="p-2 rounded-full bg-white bg-opacity-20 hover:bg-opacity-30 transition-all" :class="voiceMode ? 'bg-green-500 bg-opacity-50' : ''">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"></path>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Chat Container -->
    <div class="container mx-auto px-4 py-6">
        <div class="bg-white rounded-lg shadow-lg overflow-hidden">
            <!-- Chat Messages -->
            <div class="chat-container overflow-y-auto p-6 space-y-4" x-ref="chatContainer">
                <!-- Welcome Message -->
                <div class="flex justify-start">
                    <div class="message-bubble bg-blue-100 rounded-lg p-4">
                        <div class="flex items-center space-x-2 mb-2">
                            <div class="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center">
                                <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                                </svg>
                            </div>
                            <span class="text-sm font-medium text-gray-700">AI Assistant</span>
                        </div>
                        <p class="text-gray-800" x-text="language === 'bn' ? 'আপনাকে স্বাগতম! আমি আপনার সাহায্যে এখানে আছি। আপনি কীভাবে সাহায্য করতে পারি?' : 'Welcome! I am here to help you. How can I assist you today?'"></p>
                        <span class="text-xs text-gray-500">Just now</span>
                    </div>
                </div>

                <!-- Chat Messages -->
                <template x-for="message in messages" :key="message.id">
                    <div class="flex" :class="message.sender === 'user' ? 'justify-end' : 'justify-start'">
                        <div class="message-bubble rounded-lg p-4" :class="message.sender === 'user' ? 'bg-blue-500 text-white' : 'bg-gray-100 text-gray-800'">
                            <div x-show="message.sender === 'ai'" class="flex items-center space-x-2 mb-2">
                                <div class="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center">
                                    <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                                    </svg>
                                </div>
                                <span class="text-sm font-medium text-gray-700">AI Assistant</span>
                            </div>
                            <div x-show="message.sender === 'user'" class="flex items-center space-x-2 mb-2">
                                <span class="text-sm font-medium text-white">You</span>
                                <div class="w-8 h-8 bg-white bg-opacity-20 rounded-full flex items-center justify-center">
                                    <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                    </svg>
                                </div>
                            </div>
                            <p x-text="message.content"></p>
                            <span class="text-xs opacity-75" x-text="formatTime(message.timestamp)"></span>
                            
                            <!-- Voice Playback for AI messages -->
                            <div x-show="message.sender === 'ai' && message.audioUrl" class="mt-2">
                                <audio controls class="w-full">
                                    <source :src="message.audioUrl" type="audio/mpeg">
                                </audio>
                            </div>
                        </div>
                    </div>
                </template>

                <!-- Typing Indicator -->
                <div x-show="isTyping" class="flex justify-start">
                    <div class="message-bubble bg-gray-100 rounded-lg p-4">
                        <div class="flex items-center space-x-2">
                            <div class="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center">
                                <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                                </svg>
                            </div>
                            <span class="text-sm font-medium text-gray-700">AI Assistant</span>
                        </div>
                        <div class="flex space-x-1 mt-2">
                            <div class="w-2 h-2 bg-gray-400 rounded-full typing-indicator"></div>
                            <div class="w-2 h-2 bg-gray-400 rounded-full typing-indicator" style="animation-delay: 0.2s"></div>
                            <div class="w-2 h-2 bg-gray-400 rounded-full typing-indicator" style="animation-delay: 0.4s"></div>
                        </div>
                    </div>
                </div>

                <!-- Voice Recording Indicator -->
                <div x-show="isRecording" class="flex justify-end">
                    <div class="message-bubble bg-red-500 text-white rounded-lg p-4">
                        <div class="flex items-center space-x-2">
                            <div class="flex space-x-1">
                                <div class="w-2 h-6 bg-white rounded-full voice-wave"></div>
                                <div class="w-2 h-6 bg-white rounded-full voice-wave" style="animation-delay: 0.1s"></div>
                                <div class="w-2 h-6 bg-white rounded-full voice-wave" style="animation-delay: 0.2s"></div>
                                <div class="w-2 h-6 bg-white rounded-full voice-wave" style="animation-delay: 0.3s"></div>
                                <div class="w-2 h-6 bg-white rounded-full voice-wave" style="animation-delay: 0.4s"></div>
                            </div>
                            <span class="text-sm">Recording...</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Input Area -->
            <div class="border-t border-gray-200 p-4">
                <!-- Human Handoff Button -->
                <div x-show="showHandoffButton" class="mb-4">
                    <button @click="requestHumanHandoff()" class="w-full bg-yellow-500 text-white px-4 py-2 rounded-lg hover:bg-yellow-600 transition-colors flex items-center justify-center space-x-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                        </svg>
                        <span x-text="language === 'bn' ? 'মানুষের সাহায্য চান' : 'Request Human Help'"></span>
                    </button>
                </div>

                <div class="flex items-center space-x-4">
                    <!-- Voice Input Button -->
                    <button @click="toggleVoiceInput()" class="p-3 rounded-full transition-colors" :class="isRecording ? 'bg-red-500 text-white' : 'bg-gray-200 text-gray-600 hover:bg-gray-300'">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"></path>
                        </svg>
                    </button>

                    <!-- Text Input -->
                    <div class="flex-1">
                        <input 
                            type="text" 
                            x-model="messageInput" 
                            @keydown.enter="sendMessage()"
                            :placeholder="language === 'bn' ? 'আপনার বার্তা লিখুন...' : 'Type your message...'"
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            :disabled="isTyping || isRecording"
                        >
                    </div>

                    <!-- Send Button -->
                    <button @click="sendMessage()" :disabled="!messageInput.trim() || isTyping || isRecording" class="p-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600 disabled:opacity-50 disabled:cursor-not-allowed transition-colors">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                        </svg>
                    </button>
                </div>

                <!-- Quick Actions -->
                <div class="mt-4 flex flex-wrap gap-2">
                    <button @click="sendQuickMessage('আমার অর্ডার কখন আসবে?')" class="px-3 py-1 bg-gray-100 text-gray-700 rounded-full text-sm hover:bg-gray-200 transition-colors">
                        অর্ডার স্ট্যাটাস
                    </button>
                    <button @click="sendQuickMessage('পণ্যের দাম কত?')" class="px-3 py-1 bg-gray-100 text-gray-700 rounded-full text-sm hover:bg-gray-200 transition-colors">
                        পণ্যের দাম
                    </button>
                    <button @click="sendQuickMessage('ডেলিভারি চার্জ কত?')" class="px-3 py-1 bg-gray-100 text-gray-700 rounded-full text-sm hover:bg-gray-200 transition-colors">
                        ডেলিভারি চার্জ
                    </button>
                    <button @click="sendQuickMessage('রিফান্ড পলিসি কি?')" class="px-3 py-1 bg-gray-100 text-gray-700 rounded-full text-sm hover:bg-gray-200 transition-colors">
                        রিফান্ড পলিসি
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Rating Modal -->
    <div x-show="showRatingModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50" style="display: none;">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <h3 class="text-lg font-semibold text-gray-900 mb-4" x-text="language === 'bn' ? 'আপনার অভিজ্ঞতা রেট করুন' : 'Rate Your Experience'"></h3>
                <div class="flex justify-center space-x-2 mb-4">
                    <template x-for="i in 5" :key="i">
                        <button @click="rateConversation(i)" class="text-3xl transition-colors" :class="rating >= i ? 'text-yellow-400' : 'text-gray-300'">
                            ★
                        </button>
                    </template>
                </div>
                <p class="text-sm text-gray-600 mb-4" x-text="language === 'bn' ? 'আপনার রেটিং আমাদের উন্নতিতে সাহায্য করবে' : 'Your rating helps us improve'"></p>
                <button @click="showRatingModal = false" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition-colors">
                    <span x-text="language === 'bn' ? 'ধন্যবাদ' : 'Thank You'"></span>
                </button>
            </div>
        </div>
    </div>

    <script>
        function chatApp() {
            return {
                language: 'bn',
                voiceMode: false,
                messageInput: '',
                messages: [],
                isTyping: false,
                isRecording: false,
                showHandoffButton: false,
                showRatingModal: false,
                rating: 0,
                conversationId: null,
                clientId: 1, // Default client ID
                userName: 'User',
                failedResponses: 0,
                recognition: null,
                
                init() {
                    this.setupSpeechRecognition();
                    this.loadMessages();
                },
                
                setupSpeechRecognition() {
                    if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                        this.recognition = new SpeechRecognition();
                        this.recognition.continuous = false;
                        this.recognition.interimResults = false;
                        this.recognition.lang = 'bn-BD';
                        
                        this.recognition.onresult = (event) => {
                            const transcript = event.results[0][0].transcript;
                            this.messageInput = transcript;
                            this.sendMessage();
                        };
                        
                        this.recognition.onerror = (event) => {
                            console.error('Speech recognition error:', event.error);
                            this.isRecording = false;
                        };
                        
                        this.recognition.onend = () => {
                            this.isRecording = false;
                        };
                    }
                },
                
                toggleLanguage() {
                    this.language = this.language === 'bn' ? 'en' : 'bn';
                    if (this.recognition) {
                        this.recognition.lang = this.language === 'bn' ? 'bn-BD' : 'en-US';
                    }
                },
                
                toggleVoiceMode() {
                    this.voiceMode = !this.voiceMode;
                },
                
                toggleVoiceInput() {
                    if (this.isRecording) {
                        this.stopRecording();
                    } else {
                        this.startRecording();
                    }
                },
                
                startRecording() {
                    if (this.recognition) {
                        this.isRecording = true;
                        this.recognition.start();
                    } else {
                        alert('Speech recognition not supported in this browser');
                    }
                },
                
                stopRecording() {
                    if (this.recognition) {
                        this.recognition.stop();
                    }
                    this.isRecording = false;
                },
                
                sendMessage() {
                    if (!this.messageInput.trim()) return;
                    
                    const message = this.messageInput.trim();
                    this.messageInput = '';
                    
                    // Add user message
                    this.addMessage('user', message);
                    
                    // Show typing indicator
                    this.isTyping = true;
                    
                    // Send to API
                    this.sendToAPI(message);
                },
                
                sendQuickMessage(message) {
                    this.messageInput = message;
                    this.sendMessage();
                },
                
                async sendToAPI(message) {
                    try {
                        const response = await fetch('/api/chat/', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': this.getCSRFToken()
                            },
                            body: JSON.stringify({
                                client_id: this.clientId,
                                user_name: this.userName,
                                message: message
                            })
                        });
                        
                        const data = await response.json();
                        
                        if (response.ok) {
                            this.conversationId = data.conversation_id;
                            
                            // Add AI response
                            this.addMessage('ai', data.ai_response);
                            
                            // Check if escalation is needed
                            if (data.is_escalated) {
                                this.showHandoffButton = true;
                            }
                            
                            // Check if we should show rating
                            if (data.confidence < 0.5) {
                                this.failedResponses++;
                                if (this.failedResponses >= 2) {
                                    this.showHandoffButton = true;
                                }
                            }
                            
                            // Generate voice response if voice mode is on
                            if (this.voiceMode && data.ai_response) {
                                this.generateVoiceResponse(data.ai_response);
                            }
                        } else {
                            this.addMessage('ai', this.language === 'bn' ? 'দুঃখিত, একটি ত্রুটি হয়েছে। দয়া করে আবার চেষ্টা করুন।' : 'Sorry, an error occurred. Please try again.');
                        }
                    } catch (error) {
                        console.error('API Error:', error);
                        this.addMessage('ai', this.language === 'bn' ? 'দুঃখিত, একটি ত্রুটি হয়েছে। দয়া করে আবার চেষ্টা করুন।' : 'Sorry, an error occurred. Please try again.');
                    } finally {
                        this.isTyping = false;
                    }
                },
                
                async generateVoiceResponse(text) {
                    try {
                        const response = await fetch('/api/voice/', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': this.getCSRFToken()
                            },
                            body: JSON.stringify({
                                client_id: this.clientId,
                                caller_name: this.userName,
                                question: text
                            })
                        });
                        
                        const data = await response.json();
                        
                        if (response.ok && data.ai_audio_response_url) {
                            // Update the last AI message with audio URL
                            const lastMessage = this.messages[this.messages.length - 1];
                            if (lastMessage && lastMessage.sender === 'ai') {
                                lastMessage.audioUrl = data.ai_audio_response_url;
                            }
                        }
                    } catch (error) {
                        console.error('Voice API Error:', error);
                    }
                },
                
                async requestHumanHandoff() {
                    if (!this.conversationId) return;
                    
                    try {
                        const response = await fetch('/api/handoff/', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': this.getCSRFToken()
                            },
                            body: JSON.stringify({
                                conversation_id: this.conversationId,
                                reason: 'User requested human help'
                            })
                        });
                        
                        if (response.ok) {
                            this.addMessage('system', this.language === 'bn' ? 'আপনার অনুরোধ একজন মানুষের কাছে পাঠানো হয়েছে। শীঘ্রই কেউ আপনার সাথে যোগাযোগ করবেন।' : 'Your request has been forwarded to a human agent. Someone will contact you shortly.');
                            this.showHandoffButton = false;
                        }
                    } catch (error) {
                        console.error('Handoff Error:', error);
                    }
                },
                
                async rateConversation(rating) {
                    if (!this.conversationId) return;
                    
                    this.rating = rating;
                    
                    try {
                        const response = await fetch('/api/rate/', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': this.getCSRFToken()
                            },
                            body: JSON.stringify({
                                conversation_id: this.conversationId,
                                rating: rating
                            })
                        });
                        
                        if (response.ok) {
                            this.showRatingModal = false;
                        }
                    } catch (error) {
                        console.error('Rating Error:', error);
                    }
                },
                
                addMessage(sender, content) {
                    const message = {
                        id: Date.now(),
                        sender: sender,
                        content: content,
                        timestamp: new Date()
                    };
                    
                    this.messages.push(message);
                    this.scrollToBottom();
                    
                    // Show rating modal after AI response
                    if (sender === 'ai' && this.messages.length > 2) {
                        setTimeout(() => {
                            this.showRatingModal = true;
                        }, 2000);
                    }
                },
                
                scrollToBottom() {
                    this.$nextTick(() => {
                        const container = this.$refs.chatContainer;
                        container.scrollTop = container.scrollHeight;
                    });
                },
                
                formatTime(timestamp) {
                    return new Date(timestamp).toLocaleTimeString('bn-BD', {
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                },
                
                getCSRFToken() {
                    return document.querySelector('[name=csrfmiddlewaretoken]')?.value || '';
                },
                
                loadMessages() {
                    // Load any existing messages from localStorage or API
                    const savedMessages = localStorage.getItem('chatMessages');
                    if (savedMessages) {
                        this.messages = JSON.parse(savedMessages);
                    }
                },
                
                saveMessages() {
                    localStorage.setItem('chatMessages', JSON.stringify(this.messages));
                }
            }
        }
    </script>
</body>
</html>
