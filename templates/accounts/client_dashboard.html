<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Client Dashboard - BanglaChatPro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Bengali:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans Bengali', sans-serif; margin: 0; padding: 0; }
        .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .card-hover { transition: all 0.3s ease; }
        .card-hover:hover { transform: translateY(-2px); box-shadow: 0 10px 25px rgba(0,0,0,0.1); }

        /* Layout */
        .dashboard-container { display: flex; min-height: 100vh; }
        .sidebar {
            width: 256px;
            background: linear-gradient(to bottom, #1f2937, #111827, #0b1020);
            color: white;
            position: fixed;
            top: 0; left: 0; bottom: 0;
            z-index: 50;
            overflow-y: auto;
            transition: transform 0.3s ease;
        }
        .sidebar.hidden { transform: translateX(-100%); }
        .main-content { flex: 1; margin-left: 256px; background: #f3f4f6; min-height: 100vh; }

        /* Overlay for mobile */
        .sidebar-overlay {
            position: fixed; inset: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 40; opacity: 0; visibility: hidden;
            transition: all 0.3s ease;
        }
        .sidebar-overlay.active { opacity: 1; visibility: visible; }

        /* Responsive */
        @media (max-width: 1023px) {
            .main-content { margin-left: 0; }
        }
        @media (min-width: 1024px) {
            .sidebar.hidden { transform: translateX(0) !important; }
        }

        /* Minimal dark mode */
        .dark .main-content { background: #0f172a; }
        .dark .bg-white { background-color: #111827 !important; }
        .dark .text-gray-900 { color: #e5e7eb !important; }
        .dark .text-gray-700 { color: #cbd5e1 !important; }
        .dark .text-gray-600 { color: #94a3b8 !important; }
        .dark .border-gray-200 { border-color: #1f2937 !important; }
    </style>
</head>
<body x-data="clientDashboard()" x-init="init()">
    <div class="dashboard-container">
        <!-- Mobile Sidebar Overlay -->
        <div class="sidebar-overlay" :class="{ 'active': sidebarOpen && window.innerWidth < 1024 }" @click="sidebarOpen = false"></div>

        <!-- Sidebar -->
        <aside class="sidebar" :class="{ 'hidden': !sidebarOpen && window.innerWidth < 1024 }">
            <div class="flex items-center justify-between h-16 px-4 border-b border-gray-700/50 bg-gradient-to-r from-gray-800 to-gray-900">
                <div class="flex items-center space-x-3">
                    <div class="w-9 h-9 bg-gradient-to-br from-blue-500 to-purple-600 rounded-lg flex items-center justify-center shadow">
                        <i class="fas fa-robot text-white"></i>
                    </div>
                    <div>
                        <h1 class="text-sm font-bold">BanglaChatPro</h1>
                        <p class="text-[11px] text-gray-300">Client</p>
                    </div>
                </div>
                <button class="lg:hidden p-2 rounded text-gray-300 hover:bg-gray-700" @click="sidebarOpen = false">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <nav class="px-3 py-4 space-y-1 text-sm">
                <p class="px-3 text-[11px] uppercase tracking-wider text-gray-400">Menu</p>
                <a href="#" @click.prevent="currentView = 'dashboard'" :class="navClass('dashboard')" class="flex items-center px-3 py-2 rounded-md">
                    <i class="fas fa-gauge w-4 mr-3"></i> Dashboard
                </a>
                <a href="#" @click.prevent="is_chat_enabled ? (currentView = 'chat') : null" :class="navClass('chat') + (is_chat_enabled ? '' : ' opacity-50 cursor-not-allowed')" class="flex items-center px-3 py-2 rounded-md">
                    <i class="fas fa-comments w-4 mr-3"></i> Chat
                </a>
                <a href="#" @click.prevent="is_voice_enabled ? (currentView = 'voice') : null" :class="navClass('voice') + (is_voice_enabled ? '' : ' opacity-50 cursor-not-allowed')" class="flex items-center px-3 py-2 rounded-md">
                    <i class="fas fa-microphone w-4 mr-3"></i> Voice
                </a>
                <a href="#" @click.prevent="currentView = 'social'" :class="navClass('social')" class="flex items-center px-3 py-2 rounded-md">
                    <i class="fas fa-share-nodes w-4 mr-3"></i> Social Integrations
                </a>
                <a href="#" @click.prevent="currentView = 'profile'" :class="navClass('profile')" class="flex items-center px-3 py-2 rounded-md">
                    <i class="fas fa-user w-4 mr-3"></i> Profile
                </a>
                <a href="/logout/" class="flex items-center px-3 py-2 rounded-md text-red-300 hover:bg-gray-700 hover:text-white">
                    <i class="fas fa-sign-out-alt w-4 mr-3"></i> Logout
                </a>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Mobile Header -->
            <header class="gradient-bg text-white shadow">
                <div class="px-6 py-4 flex items-center justify-between">
                    <button class="lg:hidden p-2 rounded bg-white/10 hover:bg-white/20" @click="sidebarOpen = true">
                        <i class="fas fa-bars"></i>
                    </button>
                    <div class="flex items-center space-x-3">
                        <div class="bg-white/20 rounded-full p-2">
                            <i class="fas fa-robot text-xl"></i>
                        </div>
                        <div>
                            <h1 class="text-xl font-bold">BanglaChatPro</h1>
                            <p class="text-xs opacity-90">Welcome back, {{ user.first_name|default:user.username }}!</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-2">
                        <button @click="toggleTheme()" class="inline-flex items-center justify-center bg-white/10 px-3 py-2 rounded-lg hover:bg-white/20 transition-colors text-sm" :aria-label="theme === 'dark' ? 'Switch to light mode' : 'Switch to dark mode'">
                            <i class="fas" :class="theme === 'dark' ? 'fa-sun' : 'fa-moon'"></i>
                        </button>
                        <button @click="is_chat_enabled ? currentView='chat' : null" :class="(is_chat_enabled ? '' : 'opacity-50 cursor-not-allowed ') + 'hidden sm:inline-flex bg-white/20 px-4 py-2 rounded-lg hover:bg-white/30 transition-colors text-sm'">
                            <i class="fas fa-comments mr-2"></i>Start Chat
                        </button>
                    </div>
                </div>
            </header>

            <div class="px-6 py-8" x-show="currentView === 'dashboard'">
        <!-- Welcome Section -->
            <div class="bg-white rounded-lg shadow-sm p-6 mb-8">
            <div class="flex items-center justify-between">
                <div>
                    <h2 class="text-3xl font-bold text-gray-900 mb-2">Your Dashboard</h2>
                    <p class="text-gray-600">Monitor your AI conversations and track your usage</p>
                    <div class="mt-2" x-show="!is_approved">
                        <span class="inline-flex items-center px-2 py-1 rounded bg-yellow-100 text-yellow-700 text-xs font-medium">
                            <i class="fas fa-clock mr-2"></i> Awaiting admin approval (status: {{ approval_status }})
                        </span>
                    </div>
                </div>
                <div class="flex space-x-4">
                    <button @click="is_chat_enabled ? currentView='chat' : null"
                            :class="is_chat_enabled ? '' : 'pointer-events-none opacity-50'"
                            class="bg-purple-600 text-white px-6 py-3 rounded-lg hover:bg-purple-700 transition-colors">
                        <i class="fas fa-comments mr-2"></i>Start New Chat
                    </button>
                    <button @click="is_voice_enabled ? currentView='voice' : null"
                            :class="is_voice_enabled ? '' : 'pointer-events-none opacity-50'"
                            class="bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 transition-colors">
                        <i class="fas fa-microphone mr-2"></i>Voice Chat
                    </button>
                </div>
            </div>

            <!-- Chat Embedded View -->
            <div x-show="currentView === 'chat'" class="px-0 lg:px-6 py-6">
                <div class="bg-white rounded-lg shadow-sm">
                    <template x-if="is_chat_enabled">
                        <iframe src="/chat/" class="w-full h-[82vh] rounded-lg" style="border:0;" loading="lazy"></iframe>
                    </template>
                    <div class="p-6 text-center text-gray-600" x-show="!is_chat_enabled">
                        <i class="fas fa-lock text-xl mb-2"></i>
                        <p>Chat is disabled until your organization is approved by an admin.</p>
                    </div>
                </div>
            </div>

            <!-- Voice Embedded View -->
            <div x-show="currentView === 'voice'" class="px-0 lg:px-6 py-6">
                <div class="bg-white rounded-lg shadow-sm">
                    <template x-if="is_voice_enabled">
                        <iframe src="/voice/" class="w-full h-[82vh] rounded-lg" style="border:0;" loading="lazy"></iframe>
                    </template>
                    <div class="p-6 text-center text-gray-600" x-show="!is_voice_enabled">
                        <i class="fas fa-lock text-xl mb-2"></i>
                        <p>Voice is disabled until your organization is approved by an admin.</p>
                    </div>
                </div>
            </div>

            <!-- Social Media Embedded View -->
            <div x-show="currentView === 'social'" class="px-0 lg:px-6 py-6">
                <div class="bg-white rounded-lg shadow-sm">
                    <div class="p-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">Connected Apps</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div class="border border-gray-200 rounded-lg p-4">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center">
                                        <i class="fab fa-facebook text-blue-600 mr-2"></i>
                                        <span class="font-medium">Facebook</span>
                                    </div>
                                    <span class="text-xs font-semibold px-2 py-1 rounded" :class="social_status.facebook ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'" x-text="social_status.facebook ? 'Connected' : 'Not Connected'"></span>
                                </div>
                            </div>
                            <div class="border border-gray-200 rounded-lg p-4">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center">
                                        <i class="fab fa-whatsapp text-green-600 mr-2"></i>
                                        <span class="font-medium">WhatsApp</span>
                                    </div>
                                    <span class="text-xs font-semibold px-2 py-1 rounded" :class="social_status.whatsapp ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'" x-text="social_status.whatsapp ? 'Connected' : 'Not Connected'"></span>
                                </div>
                            </div>
                            <div class="border border-gray-200 rounded-lg p-4">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center">
                                        <i class="fab fa-instagram text-pink-600 mr-2"></i>
                                        <span class="font-medium">Instagram</span>
                                    </div>
                                    <span class="text-xs font-semibold px-2 py-1 rounded" :class="social_status.instagram ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'" x-text="social_status.instagram ? 'Connected' : 'Not Connected'"></span>
                                </div>
                            </div>
                        </div>
                        <!-- Embedded manager keeps sidebar persistent -->
                        <div class="mt-6">
                            <iframe src="/social/accounts/" class="w-full h-[70vh] rounded-lg" style="border:0;" loading="lazy"></iframe>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Profile Embedded View -->
            <div x-show="currentView === 'profile'" class="px-0 lg:px-6 py-6">
                <div class="bg-white rounded-lg shadow-sm">
                    <iframe src="/profile/" class="w-full h-[82vh] rounded-lg" style="border:0;" loading="lazy"></iframe>
                </div>
            </div>
        </div>

        <!-- Stats Cards -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="bg-white rounded-lg shadow-sm p-6 card-hover">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-blue-100 text-blue-600">
                        <i class="fas fa-comments text-xl"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">Your Conversations</p>
                        <p class="text-2xl font-bold text-gray-900" x-text="user_stats.user_conversations">0</p>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow-sm p-6 card-hover">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-green-100 text-green-600">
                        <i class="fas fa-microphone text-xl"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">Voice Calls</p>
                        <p class="text-2xl font-bold text-gray-900" x-text="user_stats.user_voice_calls">0</p>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow-sm p-6 card-hover">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-yellow-100 text-yellow-600">
                        <i class="fas fa-star text-xl"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">Average Rating</p>
                        <p class="text-2xl font-bold text-gray-900" x-text="user_stats.average_rating">0</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
            <!-- Chat Interface -->
            <div class="bg-white rounded-lg shadow-sm p-6">
                <h3 class="text-xl font-semibold text-gray-900 mb-4">AI Chat Interface</h3>
                <p class="text-gray-600 mb-4">Start a conversation with our intelligent AI assistant in Bangla language.</p>
                <div class="space-y-3">
                    <a href="/chat/" class="w-full bg-blue-600 text-white px-4 py-3 rounded-lg hover:bg-blue-700 transition-colors flex items-center justify-center">
                        <i class="fas fa-comments mr-2"></i>Start Text Chat
                    </a>
                    <a href="/voice/" class="w-full bg-green-600 text-white px-4 py-3 rounded-lg hover:bg-green-700 transition-colors flex items-center justify-center">
                        <i class="fas fa-microphone mr-2"></i>Start Voice Chat
                    </a>
                </div>
            </div>

            <!-- Recent Activity -->
            <div class="bg-white rounded-lg shadow-sm p-6">
                <h3 class="text-xl font-semibold text-gray-900 mb-4">Recent Activity</h3>
                <div class="space-y-3">
                    <div x-show="recent_conversations.length === 0" class="text-gray-500 text-center py-4">
                        <i class="fas fa-comments text-2xl mb-2"></i>
                        <p>No conversations yet</p>
                        <p class="text-sm">Start your first chat to see activity here</p>
                    </div>
                    <template x-for="conversation in recent_conversations" :key="conversation.id">
                        <div class="border border-gray-200 rounded-lg p-3">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-sm font-medium text-gray-900" x-text="conversation.user_message.substring(0, 50) + '...'"></span>
                                <span class="text-xs text-gray-500" x-text="new Date(conversation.created_at).toLocaleDateString()"></span>
                            </div>
                            <div class="text-sm text-gray-600" x-text="conversation.ai_response.substring(0, 100) + '...'"></div>
                            <div class="flex items-center mt-2">
                                <span class="text-xs text-gray-500">Rating: </span>
                                <div class="flex ml-1">
                                    <template x-for="i in 5" :key="i">
                                        <i class="fas fa-star text-xs" :class="i <= conversation.satisfaction_rating ? 'text-yellow-400' : 'text-gray-300'"></i>
                                    </template>
                                </div>
                            </div>
                        </div>
                    </template>
                </div>
            </div>
        </div>

        <!-- Features Grid -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <!-- AI Features -->
            <div class="bg-white rounded-lg shadow-sm p-6 card-hover">
                <div class="text-center">
                    <div class="bg-blue-100 rounded-full w-16 h-16 flex items-center justify-center mx-auto mb-4">
                        <i class="fas fa-brain text-2xl text-blue-600"></i>
                    </div>
                    <h3 class="text-lg font-semibold text-gray-900 mb-2">AI Assistant</h3>
                    <p class="text-gray-600 mb-4">Intelligent conversations in Bangla with context awareness.</p>
                    <a href="/chat/" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                        Try Now
                    </a>
                </div>
            </div>

            <!-- Voice Features -->
            <div class="bg-white rounded-lg shadow-sm p-6 card-hover">
                <div class="text-center">
                    <div class="bg-green-100 rounded-full w-16 h-16 flex items-center justify-center mx-auto mb-4">
                        <i class="fas fa-microphone text-2xl text-green-600"></i>
                    </div>
                    <h3 class="text-lg font-semibold text-gray-900 mb-2">Voice Chat</h3>
                    <p class="text-gray-600 mb-4">Speak naturally and get voice responses from AI.</p>
                    <a href="/voice/" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors">
                        Try Voice
                    </a>
                </div>
            </div>

            <!-- Analytics -->
            <div class="bg-white rounded-lg shadow-sm p-6 card-hover">
                <div class="text-center">
                    <div class="bg-purple-100 rounded-full w-16 h-16 flex items-center justify-center mx-auto mb-4">
                        <i class="fas fa-chart-line text-2xl text-purple-600"></i>
                    </div>
                    <h3 class="text-lg font-semibold text-gray-900 mb-2">Your Analytics</h3>
                    <p class="text-gray-600 mb-4">Track your conversation history and satisfaction ratings.</p>
                    <a href="/profile/" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition-colors">
                        View Profile
                    </a>
                </div>
            </div>
        </div>
            </div>
        </main>
    </div>

    <script>
        function clientDashboard() {
            return {
                // layout state
                sidebarOpen: window.innerWidth >= 1024,
                currentView: 'dashboard',
                theme: (localStorage.getItem('theme') === 'dark' ? 'dark' : 'light'),

                // data
                user_stats: {
                    user_conversations: {{ user_stats.user_conversations|default:0 }},
                    user_voice_calls: {{ user_stats.user_voice_calls|default:0 }},
                    average_rating: {{ user_stats.average_rating|default:0|floatformat:1 }}
                },
                recent_conversations: [],
                is_approved: {{ is_approved|yesno:'true,false' }},
                approval_status: '{{ approval_status }}',
                is_chat_enabled: {{ is_chat_enabled|yesno:'true,false' }},
                is_voice_enabled: {{ is_voice_enabled|yesno:'true,false' }},
                social_status: {
                    facebook: {{ social_status.facebook|yesno:'true,false' }},
                    whatsapp: {{ social_status.whatsapp|yesno:'true,false' }},
                    instagram: {{ social_status.instagram|yesno:'true,false' }},
                },

                init() {
                    // Safely parse recent conversations JSON if provided by the server
                    try {
                        const raw = '{{ recent_conversations|escapejs }}';
                        if (raw && raw.trim().startsWith('[')) {
                            this.recent_conversations = JSON.parse(raw);
                        }
                    } catch (e) {
                        this.recent_conversations = [];
                    }

                    // Apply theme
                    this.applyTheme();

                    window.addEventListener('resize', () => {
                        if (window.innerWidth >= 1024) {
                            this.sidebarOpen = true;
                        } else {
                            this.sidebarOpen = false;
                        }
                    });
                },

                navClass(view) {
                    return this.currentView === view
                        ? 'bg-gray-700 text-white'
                        : 'text-gray-300 hover:bg-gray-700 hover:text-white';
                },
                applyTheme() {
                    const root = document.documentElement;
                    if (this.theme === 'dark') root.classList.add('dark');
                    else root.classList.remove('dark');
                },
                toggleTheme() {
                    this.theme = this.theme === 'dark' ? 'light' : 'dark';
                    localStorage.setItem('theme', this.theme);
                    this.applyTheme();
                }
            }
        }
    </script>
</body>
</html>
